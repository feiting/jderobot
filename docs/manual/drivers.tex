\newpage
\section{Drivers. Soporte hardware}
\label{subsec:drivers}

El soporte del hardware en \textit{jdec} se realiza mediante \textit{drivers}, estos son módulos independientes que se cargan en tiempo de ejecución y que facilitan el acceso al hardware. Para ello generan esquemas perceptivos y motores, que exportan variables sensoras y de actuación.

Para cargar un nuevo driver primero ha de compilarse, generándose en este proceso un fichero con la extensión \textit{.so} que deberá ser colocado en uno de los directorios que se especifiquen en la variable de entorno \texttt{LD\_LIBRARY\_PATH}, o en el \textit{scrpit} \texttt{ponpath} que se proporciona con la plataforma. En segundo lugar se tendrá que modificar el fichero de configuración de \textit{jdec} (\texttt{jde.conf}) para indicarle que se desean cargar drivers. La forma de hacerlo es la siguiente:

\begin{verbatim}
...
driver <nombre_driver>
<parametros_configuracion_driver>
end_driver
...
\end{verbatim}

A continuación se describen los drivers que actualmente están disponibles en el repositorio oficial.

\subsection{Driver \textit{player}}
El driver \textit{player} permite a \textit{jdec} conectarse a un servidor
\textit{Player} que le transmitirá las medidas recabadas de las informaciones sensoriales de un
robot real o de un robot generado por un simulador.\\

Actualmente se dispone de soporte para \textit{sonars}
% (figura \ref{fig:sonarnumbers})
, láser
% (figura \ref{fig:sensorlaser})
, control de motores y posicionamiento del robot.

% \begin{figure}
% \begin{center}
% \begin{tabular}{c@{\hspace*{1.cm}}c}
% \includegraphics[width=4cm]{figs/sonarsensor} &
% \includegraphics[width=4cm]{figs/sonarpioneer} \\
% \end{tabular}
% \end{center}
% \caption{Sensor de ultrasonidos y corona en la base Pioneer}
% \label{fig:sonarnumbers}
% \end{figure}
% 
% \begin{figure}
% \begin{center}
% \begin{tabular}{c@{\hspace*{2.cm}}c} 
% \includegraphics[width=6cm]{figs/sensorlaser} &
% \includegraphics[width=6cm]{figs/laserpioneer} 
% \end{tabular}
% \end{center}  
% \caption{Sensor laser}  
% \label{fig:sensorlaser}  
% \end{figure}  


Para cargar este driver, el fichero de configuración de \textit{jdec} debe
contener estas líneas:

\begin{verbatim}
driver player
hostname <nombre_maquina> port <numero_puerto>
initial_position <coordenada_x> <coordenada_y> <orientacion_theta>
provides laser
provides sonars
provides encoders
provides motors
end_driver
\end{verbatim}

\begin{itemize}
\item \textit{hostname y port}: indican el nombre de máquina o
  dirección IP, y el puerto donde se encuentra lanzado el servidor
  \textit{Player}.
\item \textit{provides}: indica qué dispositivos del robot se desean
  utilizar. Cada dispositivo utilizado debe ir en una nueva línea. No
  es obligatorio usar todos.
\item \textit{initial position}: indica la posición inicial del robot
  en el mundo de coordenadas relativas de \textit{jdec}. Se precisa una
  posición X (en mm), una posición Y (en mm) y una orientación \textit{Theta} (en grados). No
  es obligatorio utilizar esta opción.
\end{itemize}

Una vez cargado generará varios esquemas perceptivos para dar los servicios pedidos.

\subsubsection{Esquema \textit{laser}}

Este esquema se encarga de refrescar una variable que comparte con el resto de esquemas y que contiene las medidas del láser. La variable se exporta con el nombre ``laser''. Esta variable contiene un \textit{array} con 180 medidas (una por grado) colocadas como se indica en la figura \ref{fig:variable_laser} \texttt{laser[0]} es la medida situada más a la derecha del robot y \texttt{laser[179]} la situada más a la izquierda.

\begin{figure}
\begin{center}
\includegraphics[width=10cm]{figs/variable_laser}
\end{center}
\caption{Medidas del sensor láser en la variable \texttt{laser[i]}}
\label{fig:variable_laser}
\end{figure}

Además de la variable con los datos del sensor, exporta otra variable, bajo el nombre de ``clock'' que crece con el número de medida, de tal forma que consultándola se puede saber si se dispone de una nueva medida.

\subsubsection{Esquema \textit{sonars}}

Este esquema se encarga de exportar al resto de esquemas los datos de la corona del \textit{sonar} del \textit{Pioneer}. Exporta para ello una variable con el nombre ``us''. Esta variable es un \textit{array} con 16 medidas (una por cada \textit{sonar} de la corona) distribuídas como se ve en la figura \ref{fig:variable_us}. \texttt{us[0]} representa el sensor delantero de la izquierda y recorre el robot en sentido horario.

\begin{figure}
\begin{center}
\includegraphics[width=9cm]{figs/variable_us}
\end{center}
\caption{Medidas de los sonares en la variable \texttt{us[i]}}
\label{fig:variable_us}
\end{figure}

Al igual que el esquema \textit{laser}, \textit{sonars} proporciona una variable ``clock'' que se va incrementando con cada nueva medida para que así se pueda conocer la existencia de datos más recientes.

\subsubsection{Esquema \textit{encoders}}

El esquema encoders proporciona las variables que indican la posición del robot (calculada mediante odometría). Para compartir los datos con otros esquemas, este esquema exporta una variable llamada ``jde\_robot''. Esta variable es un array de cinco reales (\textit{float}), en los que se indica:

\begin{enumerate}
 \item La coordenada \textit{x} de la posición respecto del origen. (ver figura \ref{fig:odometry})
 \item La coordenada \textit{y} de la posición respecto del origen.
 \item El ángulo de desfase entre el eje X y el eje central del robot, indicado en radianes
 \item El coseno del ángulo del robot
 \item El seno del ángulo del robot
\end{enumerate}

\begin{figure}
\begin{center}
\includegraphics[width=9cm]{figs/variable_odometria}
\end{center}
\caption{El robot en el mundo, posición obtenida desde odómetros}
\label{fig:odometry}
\end{figure}

Al igual que los dos esquemas anteriores, \textit{encoders} exporta una variable llamada ``clock'' que se incrementa cada vez que se actualizan los datos de las variables sensoriales.

\subsubsection{Esquema \textit{motors}}

Este esquema ofrece soporte para el movimiento del robot. Para poder controlar los movimientos del robot se utilizan dos variables que exporta el esquema llamadas ``v'' y ``w'', ambas de tipo \texttt{float}. La primera modula la velocidad de avance del robot en \textit{m/s} y la segunda la velocidad de giro en \textit{grados/segundo}.

El esquema exporta también una variable llamada ``cycle'' que permite modelar el intervalo entre actualizacines de la velocidad en la plataforma. Este intervalo se indica en \textit{ms}.


\subsection{Driver pantilt}
El driver \textit{pantilt} permite a \textit{jdec} conectarse a un cuello
mecánico \textit{Pantilt} local (figura \ref{fig:pantilt}) y transmitirle órdenes de movimiento a los motores y
recibir la información de sus sensores de posición.\\

\begin{figure}
\begin{center}
\includegraphics[width=5cm]{figs/ptu_lrg}
\end{center}
\caption{Unidad pantilt, cuello mecánico}
\label{fig:pantilt}
\end{figure}


Este driver se puede cargar mediante la siguiente configuración:

\begin{verbatim}
driver pantilt
serial <serial_port>
provides pantiltencoders
provides pantiltmotors
end_driver
\end{verbatim}

\begin{itemize}
\item \textit{serial}: indica el dispositivo serie en el que está
  conectado el cuello mecánico, por ejemplo \textit{/dev/ttyUSB0}.
\item \textit{provides}: indica qué dispositivos del cuello se desean
  utilizar. Cada dispositivo utilizado debe ir en una nueva línea. No
  es obligatorio usar todos. El dispositivo \texttt{pantiltencoders} provee la
  posición del cuello y \texttt{pantiltmotors} permite moverlo
\end{itemize}

Para permitir el acceso al hardware, el driver genera dos esquemas virtuales que permiten el control descrito.

\subsubsection{Esquema \textit{pantiltencoders}}

Proporciona información sobre la posición del cuello en cada momento. Para servir la posición, el esquema exporta dos variables, ``pan\_angle'' y ``tilt\_angle'' (ambas de tipo \textit{float}). La primera ofrece el ángulo que está girado el cuello en horizontal siendo cero la posición centrada. La segunda muestra el ángulo que está girado el cuello hacia arriba o hacia abajo, siendo cero la posición horizontal.

El esquema también exporta una variable llamada ``clock'' que permite conocer la existencia de nuevos datos en las variables perceptivas, ya que se incrementa cada vez que hay datos nuevos.

\subsubsection{Esquema \textit{pantiltmotors}}

Este esquema permite controlar el cuello mecánico por medio de cuatro variables: ``longitude'', ``latitude'', ``longitude\_speed'' y ``latitude\_speed''. Todas ellas de tipo \textit{float}. Las dos primeras se utilizan para elegir la posición en la que se desea posicionar el cuello mecánico, la primera elige el ángulo horizontal y la segunda el ángulo vertical. El cuello se colocará en esa posición a la velocidad que indiquen las variables ``longitude\_speed'' y ``latitude\_speed''.

Para seleccionar la frecuencia de envío de datos al cuello mecánico existe una variable llamada ``cicle'' (de tipo \textit{int}) en la que se puede escribir el número de ms que se desean entre cada dos escrituras puerto del dispositivo. Si bien no es recomendable modificar este parámetro ya que si se hace de forma descontrolada pordría derivar en un mal funcionamiento del hardware.

\subsection{Driver firewire}
Permite a \textit{jdec} conectarse a cámaras firewire locales mediante la
interfaz \textit{libdc1394}. Un ejemplo de estas cámaras son las que se representan en la figura \ref{fig:isight}.

\begin{figure}
 \begin{center}
  \includegraphics[width=0.3\textwidth]{figs/camara-isight.jpg}
  % camara-isight.jpg: 405x392 pixel, 72dpi, 14.29x13.83 cm, bb=
 \end{center}
\caption{Cámara firewire modelo \textit{isight}}
\label{fig:isight}
\end{figure} 

Para cargar este driver se debe utilizar una configuración del
siguiente estilo:

\begin{verbatim}
driver firewire
provides colorA <numero_camara> <autofocus_option>
provides colorB <numero_camara> <autofocus_option>
provides colorC <numero_camara> <autofocus_option>
provides colorD <numero_camara> <autofocus_option>
provides varcolorA <numero_camara> <width> <height> <autofocus_option>
provides varcolorB <numero_camara> <width> <height> <autofocus_option>
provides varcolorC <numero_camara> <width> <height> <autofocus_option>
provides varcolorD <numero_camara> <width> <height> <autofocus_option>
end_driver
\end{verbatim}

\begin{itemize}
\item \textit{provides}: indica los dispositivos de imágenes que se
  desean utilizar. Para cada dispositivo se debe indicar el número de
  cámara dentro del bus \textit{firewire} (0,1,2...). Cada dispositivo utilizado
  debe ir en una nueva línea.
\item \textit{autofocus option}: para cada dispositivo inicializado se
  puede indicar mediante las opciones \textit{autofocus\_on} o
  \textit{autofocus\_off} si se desea activar o desactivar la función
  autofocus que permiten algunas cámaras \textit{firewire}.
 \item \textit{width} y \textit{heigth}: en el caso de imágenes de tamaño variable (\textit{varcolorX})
  hay que especificar el ancho y el alto requerido. Si bien el driver
  sólo admite dos configuraciones \texttt{320x240} y \texttt{640x480}.
  En el caso de encontrarse una configuración diferente se configurará
  por defecto \texttt{320x240}.
\end{itemize}

\subsubsection{Esquemas generados por los drivers de visualización}
\label{sec:esqemas-color}

Cada entrada provides del archivo de configuración genera un esquema con el mismo nombre (``colorA'', ``colorD'', ``varcolorB''...). Cada uno de estos esquemas se encargará de proporcionar el acceso a una imagen.

Para ello exportan una variable con el mismo nombre que el esquema. Esta variable es un array de variables tipo \textit{char}, cada tres posiciones del array representan un píxel de la imagen en formato BGR, comenzando por el píxel superior izquierdo y recorriendo filas de izquierda a derecha hasta terminar por el píxel inferior derecho.
 
El número de píxeles en dicha imagen viene dado por las variables ``width'' y ``heigth'' (de tipo \textit{int}) que también exporta el esquema y que indican el ancho y el alto de la imagen respectivamente.

Por último destacar que cada esquema exporta también una variable llamada ``clock'' que se incrementa con cada nueva imagen que se escribe en las variables compartidas.

\subsection{Driver imagefile}
Permite la carga de imágenes estáticas para suplantar las imágenes de
una cámara. Hasta ahora, los formatos de imágenes soportados deben
tener extensión \textit{.pnm} o bien \textit{.ppm}, con una resolución
máxima de 320x240 píxeles. Para convertir imágenes a estos formatos se
puede utilizar la aplicación de diseño gráfico \htlink{\textit{Gimp}}{http://www.gimp.org}.\\
%\textit{Gimp}\footnote{http://www.gimp.org}.\\

La carga de este driver se realiza de la siguiente manera:

\begin{verbatim}
driver imagefile
provides colorA <path_fichero>
provides colorB <path_fichero>
provides colorC <path_fichero>
provides colorD <path_fichero>
end_driver
\end{verbatim}

\begin{itemize}
\item \textit{provides}: indica los dispositivos de imágenes que se
  desean utilizar. Para cada dispositivo se debe indicar el \textit{path} al
  fichero. Cada dispositivo utilizado debe ir en una nueva línea. No es obligatorio usar todos.
\end{itemize}

Este driver genera esquemas cómo los que se describen en el \textit{driver} de \textit{firewire} (ver página \pageref{sec:esqemas-color}).

\subsection{Driver mplayer}
Permite a \textit{jdec} capturar las imágenes de un fichero de vídeo, desde una cámara USB soportada por \textit{V4L}, desde una capturadora de vídeo, desde una entrada \textit{S-Video} o desde una capturadora de televisión.
 
Para cargar este \textit{driver} se debe utilizar una configuración del siguiente estilo:

\begin{verbatim}
driver mplayer
provides colorX <ruta del fichero> <repeat_on|off>
provides colorX v4l <dispositivo> <cam|tv|composite|s-video>
provides varcolorX <ruta del fichero> <width> <height> <repeat_on|off>
provides varcolorX v4l <dispositivo> <width> <height> <cam|tv|composite|s-video>
end_driver
\end{verbatim}

\begin{itemize}
\item \textit{provides}: Genera un nuevo esquema perceptivo que muestra un flujo de imágenes. El nombre del esquema es la segunda palabra \textit{colorX} dónde X puede ser \textit{A}, \textit{B}, \textit{C} o \textit{D}.
\item \textit{La ruta al fichero}: indica qué vídeo se va a utilizar para importar imágenes a \texttt{jdec}.
\item \textit{repeat\_on off}: se puede decidir qué hacer al llegar al final del vídeo, si queremos que se vuelva a mostrar  \textit{repeat\_on} o \textit{repeat\_off} si se desea mostrar el vídeo sólo una vez.
\item \textit{dispositivo}: Es el dispositivo que va a utilizar para capturar imágenes con \textit{V4L}. Hay que indicar con el último parámetro que tipo de dispositivo es.
\item \textit{width} y \textit{heigth}: en el caso de imágenes de tamaño variable (\textit{varcolorX}) hay que especificar el ancho y el alto requerido.
\end{itemize}

Este driver genera esquemas cómo los que se describen en el \textit{driver} de \textit{firewire} (ver página \pageref{sec:esqemas-color}).

\subsection{Driver networkserver}
El driver \textit{networkserver} permite a \textit{jdec} servir mediante una
conexión \textit{TCP/IP} la mayoría de los dispositivos que pueda tener
conectados. Entre estos se incluye cualquier cámara o imagen estática
configurada, los dispositivos del robot o un cuello mecánico.\\

El acceso a los dispositivos se puede realizar en una red local o
através de internet. Mediante este driver, \textit{jdec} se puede utilizar como
un servidor de imágenes o de dispositivos de un robot.\\

La configuración que permite iniciar este driver es la siguiente:

\begin{verbatim}
driver networkserver
socket <numero_puerto>

#images section
serves colorA <identificador_red_0>
serves colorB <identificador_red_1>
serves colorC <identificador_red_2>
serves colorD <identificador_red_3>

#pantilt section
serves pantiltencoders
serves pantiltmotors

#robot section
serves laser
serves sonars
serves encoders
serves motors
end_driver
\end{verbatim}

\begin{itemize}
\item \textit{serves}: indica los dispositivos que se
  desean servir. Cada dispositivo utilizado debe ir en una nueva
  línea. No es obligatorio usar todos. En el caso de los dispositivos
  de imágenes, se debe indicar además su identificador de imagen. De
  esta forma, el receptor puede elegir qué imagen quiere leer. Si
  alguno de los dispositivos servidos no ha sido previamente
  inicializado, este driver enviará datos inválidos.
\item \textit{socket}: indica el número de puerto en el que se atará
  el servidor del driver, y en el que podrá recibir peticiones.
\end{itemize}

\subsection{Driver networkclient}
El driver \textit{networkclient} permite a \textit{jdec} conectarse a otro \textit{jdec}
que esté usando el driver \textit{networkserver} para servir algún
dispositivo.

La conexión \textit{TCP/IP} es válida en una red local o através de
internet. La configuración que permite iniciar este driver es la siguiente:

\begin{verbatim}
driver networkclient
#images section
provides colorA <nombre_maquina> <numero_puerto> <identificador_red_0>
provides colorB <nombre_maquina> <numero_puerto> <identificador_red_1>
provides colorC <nombre_maquina> <numero_puerto> <identificador_red_1>
provides colorD <nombre_maquina> <numero_puerto> <identificador_red_1>

#pantilt section
provides pantiltencoders <nombre_maquina> <numero_puerto>
provides pantiltmotors <nombre_maquina> <numero_puerto>

#robot section
initial_position <coordenada_x> <coordenada_y> <orientacion_theta>
provides laser <nombre_maquina> <numero_puerto>
provides sonars <nombre_maquina> <numero_puerto>
provides encoders <nombre_maquina> <numero_puerto>
provides motors <nombre_maquina> <numero_puerto>
end_driver
\end{verbatim}

\begin{itemize}
\item \textit{provides}: indica qué dispositivos se desean utilizar y
  a los que se conectará el driver. Cada dispositivo utilizado debe ir
  en una nueva línea. No es obligatorio usar todos. Para cada
  dispositivo se debe indicar el nombre de la máquina o la dirección
  IP y el puerto donde se encuentra el servidor. En el caso de las
  imágenes, también es necesario indicar el identificador de la misma.
\item \textit{initial position}: indica la posición inicial del robot
  en el mundo de coordenadas relativas de \textit{jdec}. Se precisa una
  posición \textit{X}, una posición \textit{Y} y una orientación en radianes \textit{Theta}. No
  es obligatorio utilizar esta opción.
\end{itemize}

Este \textit{driver} genera esquemas virtuales para cada sentencia \textit{provides} iguales a los que generan los drivers genuinos de cada elemento que se sirve (ver apartados anteriores).

